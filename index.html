<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>AURA_LAB | æ·±åº¦èƒ½é‡æŒ‡å—</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        :root { --accent-color: #d4af37; --text-main: #e0e0e0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang HK", sans-serif; 
            background: #121212; color: var(--text-main); margin: 0; padding: 15px; line-height: 1.8; touch-action: manipulation;
            /* éœ€æ±‚ 3: å¢åŠ å·¦å³é–“è·ä»¥æ”¾ç½®èƒŒæ™¯åœ– */
            display: flex; justify-content: center;
        }

        /* éœ€æ±‚ 3: ç¶²é å·¦å³å¢åŠ æ°´æ™¶ç”¢å“è£é£¾åœ– */
        .side-decor {
            position: fixed; top: 50px; width: 150px; opacity: 0.4; z-index: -1;
            display: flex; flex-direction: column; gap: 20px;
        }
        .side-decor.left { left: 20px; }
        .side-decor.right { right: 20px; }
        .side-decor img { width: 100%; border-radius: 12px; border: 1px solid #333; }
        @media (max-width: 900px) { .side-decor { display: none; } }

        .container { 
            max-width: 480px; width: 100%; margin: 10px auto; background: #1e1e1e; padding: 25px 20px; border-radius: 24px; border: 1px solid #333; box-sizing: border-box; 
        }
        h2 { text-align: center; color: var(--accent-color); letter-spacing: 4px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; }
        
        input, select { 
            width: 100%; padding: 14px; background: #2a2a2a; border: 1px solid #444; border-radius: 12px; color: white; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; outline: none;
        }
        select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23aaa' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: calc(100% - 15px) center; }

        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-top: 12px; font-size: 13px; color: #888; cursor: pointer; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; border-radius: 6px; border: 2px solid #444; appearance: auto; cursor: pointer; }

        button#mainBtn, #confirmBtn { 
            width: 100%; padding: 16px; background: linear-gradient(135deg, var(--accent-color) 0%, #333 150%); color: #121212; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        #result { margin-top: 35px; display: none; }
        .bazi-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #444; text-align: center; }
        .bazi-table td { padding: 10px; border: 1px solid #333; }
        .data-cell { font-size: 20px; font-weight: bold; }

        .color-é‡‘ { color: #ffd700 !important; } .color-æœ¨ { color: #4caf50 !important; }
        .color-æ°´ { color: #2196f3 !important; } .color-ç« { color: #ff5252 !important; }
        .color-åœŸ { color: #ff9800 !important; }
        
        .stat-row { margin-bottom: 12px; }
        .stat-label { display: flex; justify-content: space-between; font-size: 12px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; transition: width 1s; }
        .bg-é‡‘ { background: #ffd700; } .bg-æœ¨ { background: #4caf50; } .bg-æ°´ { background: #2196f3; } .bg-ç« { background: #ff5252; } .bg-åœŸ { background: #ff9800; }

        .fortune-tabs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .tab-btn { padding: 10px; background: #2a2a2a; border: 1px solid #444; color: #888; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .tab-btn.active { background: var(--accent-color); color: #121212; font-weight: bold; }

        /* éœ€æ±‚ 1: ç¢ºèªåˆ†ææŒ‰éˆ•å€åŸŸ */
        #confirmSection { display: none; margin: 15px 0; text-align: center; }

        .recommend-area { margin-top: 20px; display: none; }
        .search-btn { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: #fff; color: #121212; text-decoration: none; border-radius: 12px; font-weight: bold; margin-top: 10px; border-left: 5px solid var(--accent-color); }
        
        /* éœ€æ±‚ 2: ç§»é™¤ç©ºéš™ï¼Œè¨­ç½® margin-top ç‚º 0 */
        .fortune-content { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; font-size: 15px; color: #ddd; border: 1px solid #444; margin-top: 0; }
        .fortune-content b { color: var(--accent-color); }
    </style>
</head>
<body>

<div class="side-decor left">
    <img src="https://crystale.co/cdn/shop/articles/1000_F_300587365_AbsOplaq4aYcnQAM76yS8coJenyst0gu_c0a320e3-7caa-4cbc-b4da-413b88d9e213_1080x.jpg?v=1658806732">
    <img src="https://images.unsplash.com/photo-1627734135359-598d9c57d197?w=200">
</div>
<div class="side-decor right">
    <img src="https://images.unsplash.com/photo-1506362802273-df10b3988077?w=200">
    <img src="https://images.unsplash.com/photo-1596280608464-2453f600f723?w=200">
</div>

<div class="container">
    <h2 id="storeTitle">AURA_LAB</h2>
    <div class="form-group"><label>å§“å</label><input type="text" id="userName" placeholder="è¼¸å…¥å§“å"></div>
    <div class="form-group"><label>æ€§åˆ¥</label><select id="userGender"><option value="ç”·">ç”·æ€§</option><option value="å¥³">å¥³æ€§</option></select></div>
    <div class="form-group"><label>å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="birthDate"></div>
    <div class="form-group">
        <label>å‡ºç”Ÿæ™‚é–“</label>
        <select id="birthTime">
            <option value="00:00">00:00 (å­æ™‚)</option><option value="01:00">01:00 (ä¸‘æ™‚)</option><option value="02:00">02:00 (ä¸‘æ™‚)</option><option value="03:00">03:00 (å¯…æ™‚)</option><option value="04:00">04:00 (å¯…æ™‚)</option><option value="05:00">05:00 (å¯æ™‚)</option><option value="06:00">06:00 (å¯æ™‚)</option><option value="07:00">07:00 (è¾°æ™‚)</option><option value="08:00">08:00 (è¾°æ™‚)</option><option value="09:00">09:00 (å·³æ™‚)</option><option value="10:00">10:00 (å·³æ™‚)</option><option value="11:00">11:00 (åˆæ™‚)</option><option value="12:00" selected>12:00 (åˆæ™‚)</option><option value="13:00">13:00 (æœªæ™‚)</option><option value="14:00">14:00 (æœªæ™‚)</option><option value="15:00">15:00 (ç”³æ™‚)</option><option value="16:00">16:00 (ç”³æ™‚)</option><option value="17:00">17:00 (é…‰æ™‚)</option><option value="18:00">18:00 (é…‰æ™‚)</option><option value="19:00">19:00 (æˆŒæ™‚)</option><option value="20:00">20:00 (æˆŒæ™‚)</option><option value="21:00">21:00 (äº¥æ™‚)</option><option value="22:00">22:00 (äº¥æ™‚)</option><option value="23:00">23:00 (å­æ™‚)</option>
        </select>
        <label class="checkbox-group"><input type="checkbox" id="unknownTime" onchange="handleUnknownTime(this)"><span>æˆ‘ä¸ç¢ºå®šå…·é«”å‡ºç”Ÿæ™‚é–“ (é è¨­ä¸‹åˆ12é»)</span></label>
    </div>

    <button id="mainBtn" onclick="calculateBazi()">æƒæèƒ½é‡å ´</button>

    <div id="result">
        <table class="bazi-table"><tr id="rowTianGan"></tr><tr id="rowDiZhi"></tr></table>
        <div id="statsContainer"></div>
        <div class="fortune-tabs">
            <button class="tab-btn" onclick="prepareAI('è²¡é‹', this)">ğŸ’° è²¡é‹</button>
            <button class="tab-btn" onclick="prepareAI('æ¡ƒèŠ±', this)">â¤ï¸ æ¡ƒèŠ±</button>
            <button class="tab-btn" onclick="prepareAI('äº‹æ¥­', this)">ğŸ’¼ äº‹æ¥­</button>
            <button class="tab-btn" onclick="prepareAI('å­¸æ¥­', this)">ğŸ“š å­¸æ¥­</button>
            <button class="tab-btn" onclick="prepareAI('æƒ…ç·’', this)">ğŸ§˜ æƒ…ç·’</button>
            <button class="tab-btn" onclick="prepareAI('å¥åº·', this)">ğŸ¥ å¥åº·</button>
        </div>

        <div id="confirmSection">
            <button id="confirmBtn" onclick="askAI()">ç¢ºèªé€²è¡Œæ·±åº¦èƒ½é‡åˆ†æ</button>
        </div>

        <div class="fortune-content" id="fortuneText" style="display:none;"></div>
        <div id="recommendArea" class="recommend-area"><div style="font-size:12px; color:#777;">ğŸ” æ¨è–¦æ°´æ™¶é…å°å»ºè­°ï¼š</div><div id="searchLinks"></div></div>
    </div>
</div>

<script>
let currentBaziData = ""; let currentMinEl = ""; let selectedCat = "";
const API_KEY = "sk-7accfbb7c3e3471bb5284983b0aaf3b0";
const SHOPLINE_SEARCH_BASE = "https://www.changsangstore.com.hk/zh-hant/search?q=";
const elementColors = {"é‡‘":"#ffd700","æœ¨":"#4caf50","æ°´":"#2196f3","ç«":"#ff5252","åœŸ":"#ff9800"};

function handleUnknownTime(checkbox) {
    const timeSelect = document.getElementById('birthTime');
    if (checkbox.checked) { timeSelect.value = "12:00"; timeSelect.disabled = true; } else { timeSelect.disabled = false; }
}

function calculateBazi() {
    const btn = document.getElementById('mainBtn'); btn.innerText = "è¨ˆç®—ä¸­...";
    try {
        const dateStr = document.getElementById('birthDate').value;
        if(!dateStr) { alert("è«‹é¸æ“‡æ—¥æœŸ"); btn.innerText = "æƒæèƒ½é‡å ´"; return; }
        const solar = Solar.fromYmdHms(parseInt(dateStr.split('-')[0]), parseInt(dateStr.split('-')[1]), parseInt(dateStr.split('-')[2]), parseInt(document.getElementById('birthTime').value.split(':')[0]), 0, 0);
        const eightChars = solar.getLunar().getEightChar();
        const gz = [[eightChars.getYearGan(), eightChars.getYearZhi()],[eightChars.getMonthGan(), eightChars.getMonthZhi()],[eightChars.getDayGan(), eightChars.getDayZhi()],[eightChars.getTimeGan(), eightChars.getTimeZhi()]];
        currentBaziData = `æ€§åˆ¥:${document.getElementById('userGender').value}, å¹´æŸ±:${gz[0].join('')}, æœˆæŸ±:${gz[1].join('')}, æ—¥æŸ±:${gz[2].join('')}, æ™‚æŸ±:${gz[3].join('')}`;
        const elementMap = {"ç”²":"æœ¨","ä¹™":"æœ¨","ä¸™":"ç«","ä¸":"ç«","æˆŠ":"åœŸ","å·±":"åœŸ","åºš":"é‡‘","è¾›":"é‡‘","å£¬":"æ°´","ç™¸":"æ°´","å­":"æ°´","äº¥":"æ°´","å¯…":"æœ¨","å¯":"æœ¨","å·³":"ç«","åˆ":"ç«","ç”³":"é‡‘","é…‰":"é‡‘","è¾°":"åœŸ","æˆŒ":"åœŸ","ä¸‘":"åœŸ","æœª":"åœŸ"};
        let stats = {"é‡‘":0, "æœ¨":0, "æ°´":0, "ç«":0, "åœŸ":0};
        gz.forEach(p => { stats[elementMap[p[0]]]++; stats[elementMap[p[1]]]++; });
        currentMinEl = Object.keys(stats).reduce((a, b) => stats[a] < stats[b] ? a : b);
        document.documentElement.style.setProperty('--accent-color', elementColors[currentMinEl]);
        document.getElementById('rowTianGan').innerHTML = `<td>å¤©å¹²</td>` + gz.map(item => `<td class="data-cell color-${elementMap[item[0]]}">${item[0]}</td>`).join('');
        document.getElementById('rowDiZhi').innerHTML = `<td>åœ°æ”¯</td>` + gz.map(item => `<td class="data-cell color-${elementMap[item[1]]}">${item[1]}</td>`).join('');
        let statsHtml = ''; ["é‡‘", "æœ¨", "æ°´", "ç«", "åœŸ"].forEach(el => {
            const per = (stats[el] / 8 * 100).toFixed(0);
            statsHtml += `<div class="stat-row"><div class="stat-label"><span>${el}</span><span>${per}%</span></div><div class="progress-bar-bg"><div class="progress-bar-fill bg-${el}" style="width:${per}%"></div></div></div>`;
        });
        document.getElementById('statsContainer').innerHTML = statsHtml;
        document.getElementById('result').style.display = 'block'; btn.innerText = "æƒææˆåŠŸ";
    } catch (e) { alert("å‡ºéŒ¯äº†ã€‚"); btn.innerText = "æƒæèƒ½é‡å ´"; }
}

/* éœ€æ±‚ 1: ç”¨æˆ¶é»æ“Šåˆ†é¡å¾Œï¼Œåƒ…è¨˜éŒ„åˆ†é¡ä¸¦é¡¯ç¤ºç¢ºèªæŒ‰éˆ• */
function prepareAI(category, btn) {
    selectedCat = category;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('confirmSection').style.display = 'block';
    document.getElementById('fortuneText').style.display = 'none';
    document.getElementById('recommendArea').style.display = 'none';
}

async function askAI() {
    const display = document.getElementById('fortuneText');
    const confirmSec = document.getElementById('confirmSection');
    confirmSec.style.display = 'none';
    display.style.display = 'block';
    
    /* éœ€æ±‚ 1: ä¿®æ”¹ç­‰å¾…æ–‡æ¡ˆ */
    display.innerHTML = `<b class="color-${currentMinEl}">ğŸ”® æ­£åœ¨é€£æ¥æ˜Ÿç›¤æ•¸æ“šä¸¦é€²è¡Œæ·±åº¦è§£è®€... åˆ†æå¯èƒ½æœƒèŠ± 15 ç§’å·¦å³ï¼Œè«‹è€å¿ƒç­‰å¾…ã€‚</b>`;
    
    try {
        const response = await fetch("https://api.deepseek.com/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                    { role: "system", content: `ä½ æ˜¯ä¸€ä½è³‡æ·±äº”è¡Œèƒ½é‡åˆ†æå¸«ã€‚
                        ç©©å®šè¦æ±‚ï¼ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼‰ï¼š
                        1. é¦–å…ˆä¸€ä¸Šä¾†æ ¹æ“šä»Šå¹´çš„äº”è¡Œé‹å‹¢å®¢è§€æ¨è–¦ä¸‰æ¬¾æœ€å¥‘åˆçš„æ°´æ™¶ã€‚æ ¼å¼åš´æ ¼ç‚º [REC]:æ°´æ™¶1,æ°´æ™¶2,æ°´æ™¶3ã€‚
                        2. éš¨å¾Œé€²è¡Œæ·±åº¦åˆ†æï¼Œå…§å®¹å¿…é ˆçµ±ä¸€ä½¿ç”¨ã€Œå…¬æ›†æœˆä»½ã€ã€‚åˆ†æå…§å®¹æ‡‰åŒ…å«2026å¹´å…¨å¹´çš„èµ°å‹¢ï¼Œä¸¦ä¸”æ¨è–¦å¯ä»¥å¸¶çš„æ°´æ™¶ç¨®é¡ã€‚
                        3. åŠ ç²—é‡é»ï¼Œä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿï¼Œèªæ°£å¹³å’Œå®¢è§€ã€‚
                        4. çµå°¾è«‹èªªæ˜æ°´æ™¶ç‚ºèƒ½é‡å¹³è¡¡å·¥å…·ã€‚
                        5. ä¸è¦æåˆ°æ˜¯DeepSeekæˆ–è€…æ˜¯AIç”Ÿæˆ` },
                    { role: "user", content: `å§“åï¼š${document.getElementById('userName').value}ã€‚å…«å­—ã€æ€§åˆ¥èˆ‡æ™‚è¾°ç‹€æ…‹ï¼š${currentBaziData}ã€‚ç¼ºå¤±ï¼š${currentMinEl}ã€‚åˆ†æã€${selectedCat}ã€‘ã€‚` }
                ]
            })
        });
        const data = await response.json();
        const fullContent = data.choices[0].message.content;
        const recMatch = fullContent.match(/\[REC\]:(.+)/);
        if(recMatch) {
            const linkBox = document.getElementById('searchLinks'); linkBox.innerHTML = '';
            recMatch[1].split(/[,ï¼Œã€]/).forEach(name => {
                linkBox.innerHTML += `<a href="${SHOPLINE_SEARCH_BASE + encodeURIComponent(name.trim())}" target="_blank" class="search-btn">âœ¨ ç²å–ã€${name.trim()}ã€‘<span>é€²å…¥åº—èˆ–</span></a>`;
            });
            document.getElementById('recommendArea').style.display = 'block';
        }
        
        /* éœ€æ±‚ 2: ä½¿ç”¨ .trim() åˆªé™¤é–‹é ­ç©ºéš™ä¸¦æ¸²æŸ“æ–‡å­— */
        display.innerHTML = fullContent.replace(/\[REC\]:.+/, "").trim().replace(/\*\*(.*?)\*\*/g, `<b class="color-${currentMinEl}">$1</b>`).replace(/\n/g, "<br>");
    } catch (e) { display.innerHTML = "ç³»çµ±ç¹å¿™ã€‚"; }
}
</script>
</body>
</html>

