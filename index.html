<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA_LAB | AI èƒ½é‡æœˆä»½æŒ‡å—</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        body { font-family: 'PingFang HK', sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; line-height: 1.8; }
        .container { max-width: 480px; margin: 0 auto; background: #1e1e1e; padding: 30px 20px; border-radius: 24px; border: 1px solid #333; }
        h2 { text-align: center; color: #d4af37; letter-spacing: 4px; }
        .subtitle { text-align: center; font-size: 11px; color: #777; margin-bottom: 30px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; }
        input { width: 100%; padding: 14px; background: #2a2a2a; border: 1px solid #444; border-radius: 12px; color: white; box-sizing: border-box; font-size: 16px; }
        button#mainBtn { width: 100%; padding: 16px; background: linear-gradient(135deg, #d4af37 0%, #b8962e 100%); color: #121212; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; }

        #result { margin-top: 35px; display: none; }
        
        .bazi-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #444; text-align: center; }
        .bazi-table td { padding: 10px; border: 1px solid #333; }
        .data-cell { font-size: 20px; font-weight: bold; }

        .stat-row { margin-bottom: 12px; }
        .stat-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; transition: width 1s; }
        .bg-é‡‘ { background: #ffd700; } .bg-æœ¨ { background: #4caf50; } .bg-æ°´ { background: #2196f3; } .bg-ç« { background: #ff5252; } .bg-åœŸ { background: #ff9800; }

        .fortune-tabs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .tab-btn { padding: 10px; background: #2a2a2a; border: 1px solid #444; color: #888; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .tab-btn.active { background: #d4af37; color: #121212; font-weight: bold; }
        
        /* å¼·åŒ– AI æ–‡å­—é¡¯ç¤º */
        .fortune-content { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; font-size: 15px; color: #ddd; border: 1px solid #444; min-height: 150px; }
        .fortune-content b, .fortune-content strong { color: #d4af37; font-weight: bold; }

        .recommend-title { margin-top: 30px; font-size: 14px; color: #d4af37; border-bottom: 1px solid #d4af37; display: inline-block; padding-bottom: 5px; }
        .search-links-container { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .search-btn { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: #fff; color: #121212; text-decoration: none; border-radius: 12px; font-weight: bold; transition: 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <h2>AURA_LAB</h2>
    <div class="subtitle">AI SEASONAL ENERGY GUIDE</div>
    
    <div class="form-group">
        <label>å§“å / NAME</label>
        <input type="text" id="userName" placeholder="è¼¸å…¥å§“å">
    </div>
    <div class="form-group">
        <label>å‡ºç”Ÿæ—¥æœŸ / BIRTH DATE</label>
        <input type="date" id="birthDate">
    </div>
    <div class="form-group">
        <label>å‡ºç”Ÿæ™‚è¾° / TIME</label>
        <input type="time" id="birthTime" value="12:00">
    </div>
    <button id="mainBtn" onclick="calculateBazi()">é–‹å•Ÿèƒ½é‡æƒæ</button>

    <div id="result">
        <table class="bazi-table"><tr id="rowTianGan"></tr><tr id="rowDiZhi"></tr></table>
        <div class="stats-container" id="statsContainer"></div>

        <div class="fortune-section">
            <div class="fortune-tabs">
                <button class="tab-btn" onclick="askAI('è²¡é‹', this)">ğŸ’° è²¡é‹</button>
                <button class="tab-btn" onclick="askAI('æ¡ƒèŠ±', this)">â¤ï¸ æ¡ƒèŠ±</button>
                <button class="tab-btn" onclick="askAI('äº‹æ¥­', this)">ğŸ’¼ äº‹æ¥­</button>
                <button class="tab-btn" onclick="askAI('å­¸æ¥­', this)">ğŸ“š å­¸æ¥­</button>
                <button class="tab-btn" onclick="askAI('æƒ…ç·’', this)">ğŸ§˜ æƒ…ç·’</button>
                <button class="tab-btn" onclick="askAI('å¥åº·', this)">ğŸ¥ å¥åº·</button>
            </div>
            <div class="fortune-content" id="fortuneText">è«‹é¸æ“‡æ„Ÿèˆˆè¶£çš„é ˜åŸŸ...</div>
        </div>

        <div id="recommendArea" style="display:none;">
            <div class="recommend-title">å‘½å®šèƒ½é‡ç‰©å»ºè­°</div>
            <div class="search-links-container" id="searchLinks"></div>
        </div>
    </div>
</div>

<script>
let currentBaziData = "";
let currentMinEl = "";
const API_KEY = "sk-7accfbb7c3e3471bb5284983b0aaf3b0";
const SHOPLINE_SEARCH_BASE = "https://www.changsangstore.com.hk/zh-hant/search?q=";

const elementMap = {"ç”²":"æœ¨","ä¹™":"æœ¨","ä¸™":"ç«","ä¸":"ç«","æˆŠ":"åœŸ","å·±":"åœŸ","åºš":"é‡‘","è¾›":"é‡‘","å£¬":"æ°´","ç™¸":"æ°´","å­":"æ°´","äº¥":"æ°´","å¯…":"æœ¨","å¯":"æœ¨","å·³":"ç«","åˆ":"ç«","ç”³":"é‡‘","é…‰":"é‡‘","è¾°":"åœŸ","æˆŒ":"åœŸ","ä¸‘":"åœŸ","æœª":"åœŸ"};

function calculateBazi() {
    const dateStr = document.getElementById('birthDate').value;
    const timeStr = document.getElementById('birthTime').value;
    if(!dateStr) return alert("è«‹é¸æ“‡æ—¥æœŸ");
    const dateArr = dateStr.split('-'); const timeArr = timeStr.split(':');
    const solar = Solar.fromYmdHms(parseInt(dateArr[0]), parseInt(dateArr[1]), parseInt(dateArr[2]), parseInt(timeArr[0]), parseInt(timeArr[1]), 0);
    const eightChars = solar.getLunar().getEightChar();
    const gz = [[eightChars.getYearGan(), eightChars.getYearZhi()],[eightChars.getMonthGan(), eightChars.getMonthZhi()],[eightChars.getDayGan(), eightChars.getDayZhi()],[eightChars.getTimeGan(), eightChars.getTimeZhi()]];
    currentBaziData = `å¹´æŸ±:${gz[0].join('')}, æœˆæŸ±:${gz[1].join('')}, æ—¥æŸ±:${gz[2].join('')}, æ™‚æŸ±:${gz[3].join('')}`;

    document.getElementById('rowTianGan').innerHTML = `<td>å¤©å¹²</td>` + gz.map(item => `<td class="data-cell">${item[0]}</td>`).join('');
    document.getElementById('rowDiZhi').innerHTML = `<td>åœ°æ”¯</td>` + gz.map(item => `<td class="data-cell">${item[1]}</td>`).join('');

    let stats = {"é‡‘":0, "æœ¨":0, "æ°´":0, "ç«":0, "åœŸ":0};
    gz.forEach(p => { stats[elementMap[p[0]]]++; stats[elementMap[p[1]]]++; });
    currentMinEl = "é‡‘"; let minVal = 9;
    for(let key in stats) { if(stats[key] < minVal) { minVal = stats[key]; currentMinEl = key; } }

    const statsCon = document.getElementById('statsContainer');
    statsCon.innerHTML = '';
    ["é‡‘", "æœ¨", "æ°´", "ç«", "åœŸ"].forEach(el => {
        const per = (stats[el] / 8 * 100).toFixed(0);
        statsCon.innerHTML += `<div class="stat-row"><div class="stat-label"><span>${el}</span><span>${per}%</span></div><div class="progress-bar-bg"><div class="progress-bar-fill bg-${el}" style="width:${per}%"></div></div></div>`;
    });
    document.getElementById('result').style.display = 'block';
}

async function askAI(category, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const display = document.getElementById('fortuneText');
    const recommendArea = document.getElementById('recommendArea');
    display.innerHTML = "ğŸ”® <b>æ­£åœ¨é€£æ¥æ˜Ÿç›¤æ•¸æ“šä¸¦é€²è¡Œ AI æ·±åº¦è§£è®€...</b>";
    recommendArea.style.display = 'none';

    try {
        const response = await fetch("https://api.deepseek.com/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                    { role: "system", content: "ä½ æ˜¯ä¸€ä½è³‡æ·±äº”è¡Œèƒ½é‡åˆ†æå¸«ã€‚å›è¦†è¦æ±‚ï¼š1. ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚2. å…§å®¹è¦åŒ…å«ã€æ•´é«”åˆ†æã€‘èˆ‡ã€2026å¹´åº¦æœˆä»½é‡é»æŒ‡å—ã€‘ã€‚3. é‡å°ä¸åŒå­£åº¦ï¼ˆå¦‚æ˜¥å¤ç§‹å†¬ï¼‰æ¨è–¦é©åˆä½©æˆ´çš„æ°´æ™¶ä»¥å¹³è¡¡ç‰¹å®šæœˆä»½çš„èƒ½é‡ã€‚4. ä½¿ç”¨ Markdown æ ¼å¼åŠ ç²—é‡é»ï¼Œå¤šç”¨è¡¨æƒ…ç¬¦è™Ÿã€‚5. èªæ°£å®¢è§€ï¼Œæœ€å¾Œå®¢è§€æ¨è–¦ä¸‰æ¬¾æ°´æ™¶ä¸¦éµå®ˆæ ¼å¼ï¼š[REC]:æ°´æ™¶1,æ°´æ™¶2,æ°´æ™¶3" },
                    { role: "user", content: `å§“åï¼š${document.getElementById('userName').value}ã€‚å…«å­—ï¼š${currentBaziData}ã€‚äº”è¡Œç¼ºï¼š${currentMinEl}ã€‚åˆ†æã€${category}ã€‘é‹å‹¢åŠæœˆä»½æ°´æ™¶å»ºè­°ã€‚` }
                ]
            })
        });

        const data = await response.json();
        const fullContent = data.choices[0].message.content;
        const recMatch = fullContent.match(/\[REC\]:(.+)/);
        const crystalList = recMatch ? recMatch[1].split(',') : [];
        
        // æ¸²æŸ“ Markdown (ç°¡å–®æ›¿æ›)
        let formatted = fullContent.replace(/\[REC\]:.+/, "")
            .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
            .replace(/\n/g, "<br>");
        
        display.innerHTML = formatted;
        
        if(crystalList.length > 0) {
            const linkBox = document.getElementById('searchLinks');
            linkBox.innerHTML = '';
            crystalList.forEach(name => {
                const searchUrl = SHOPLINE_SEARCH_BASE + encodeURIComponent(name.trim());
                linkBox.innerHTML += `<a href="${searchUrl}" target="_blank" class="search-btn">âœ¨ ç²å–ã€${name.trim()}ã€‘<span>é€²å…¥åº—èˆ–</span></a>`;
            });
            recommendArea.style.display = 'block';
        }
        window.scrollTo({ top: display.offsetTop - 50, behavior: 'smooth' });
    } catch (error) { display.innerHTML = "AI é€£æ¥å¤±æ•—ã€‚"; }
}
</script>
</body>
</html>
